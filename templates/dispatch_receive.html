{% extends "base.html" %}
{% block content %}

<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h2 text-dark fw-bold mb-2">Receive Dispatch</h1>
          <p class="text-muted mb-0">Manage incoming dispatches and mark them as received</p>
        </div>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left me-2"></i>Back to Dashboard
        </a>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm border-0">
        <div class="card-header bg-transparent border-0">
          <h5 class="card-title mb-0 text-dark">
            <i class="bi bi-box-arrow-in-down text-primary me-2"></i>
            Pending Dispatches
          </h5>
        </div>
        <div class="card-body">
          {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
              {% for cat, msg in messages %}
                <div class="alert alert-{{ cat }} alert-dismissible fade show mb-4" role="alert">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-{% if cat == 'success' %}check-circle-fill{% elif cat == 'danger' %}exclamation-triangle-fill{% else %}info-circle-fill{% endif %} me-2"></i>
                    <span>{{ msg }}</span>
                  </div>
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            {% endif %}
          {% endwith %}

          {% if dispatches %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th>ID</th>
                  <th>From</th>
                  <th>Component</th>
                  <th class="text-center">FLC Qty</th>
                  <th class="text-center">Component Qty</th>
                  <th class="text-center">Status</th>
                  <th>Date/Time</th>
                  <th class="text-center">Action</th>
                </tr>
              </thead>
              <tbody>
                {% for d in dispatches %}
                <tr>
                  <td class="fw-semibold text-primary">#{{ d.id }}</td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="bg-primary bg-opacity-10 rounded p-2 me-2">
                        <i class="bi bi-person text-primary"></i>
                      </div>
                      <div>
                        <div class="fw-semibold text-dark">{{ d.sender.username if d.sender else d.from_role }}</div>
                        <small class="text-muted">{{ d.from_role }}</small>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div class="d-flex align-items-center">
                      <div class="bg-info bg-opacity-10 rounded p-2 me-2">
                        <i class="bi bi-cpu text-info"></i>
                      </div>
                      <span class="fw-semibold text-dark">{{ d.component }}</span>
                    </div>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-primary fs-6">{{ d.flc_qty }}</span>
                  </td>
                  <td class="text-center">
                    <span class="badge bg-secondary fs-6">{{ d.component_qty }}</span>
                  </td>
                  <td class="text-center">
                    {% if d.status == 'Received' %}
                      <span class="badge bg-success">
                        <i class="bi bi-check-circle me-1"></i>Received
                      </span>
                    {% else %}
                      <span class="badge bg-warning text-dark">
                        <i class="bi bi-hourglass-split me-1"></i>{{ d.status }}
                      </span>
                    {% endif %}
                  </td>
                  <td>
                    <small class="text-muted">{{ d.date_time.strftime('%d %b %Y, %H:%M') }}</small>
                  </td>
                  <td class="text-center">
                    {% if d.status != 'Received' %}
                      <form method="POST" action="{{ url_for('dispatch_receive') }}" class="d-inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <input type="hidden" name="dispatch_id" value="{{ d.id }}">
                        <button type="submit" class="btn btn-success btn-sm" 
                                data-bs-toggle="tooltip" title="Mark as Received">
                          <i class="bi bi-check-lg me-1"></i>Receive
                        </button>
                      </form>
                    {% else %}
                      <span class="text-success">
                        <i class="bi bi-check-circle-fill me-1"></i>Completed
                      </span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>

          <!-- Summary Stats -->
          <div class="row mt-4">
            <div class="col-md-3">
              <div class="card stat-card border-0">
                <div class="card-body text-center">
                  <div class="text-primary mb-2">
                    <i class="bi bi-list-ul fs-2"></i>
                  </div>
                  <h4 class="text-dark mb-1">{{ dispatches|length }}</h4>
                  <p class="text-muted mb-0">Total Dispatches</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stat-card border-0">
                <div class="card-body text-center">
                  <div class="text-warning mb-2">
                    <i class="bi bi-hourglass-split fs-2"></i>
                  </div>
                  <h4 class="text-dark mb-1">{{ dispatches|selectattr('status', 'equalto', 'Pending')|list|length }}</h4>
                  <p class="text-muted mb-0">Pending</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stat-card border-0">
                <div class="card-body text-center">
                  <div class="text-success mb-2">
                    <i class="bi bi-check-circle fs-2"></i>
                  </div>
                  <h4 class="text-dark mb-1">{{ dispatches|selectattr('status', 'equalto', 'Received')|list|length }}</h4>
                  <p class="text-muted mb-0">Received</p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card stat-card border-0">
                <div class="card-body text-center">
                  <div class="text-info mb-2">
                    <i class="bi bi-clock-history fs-2"></i>
                  </div>
                  <h4 class="text-dark mb-1">{{ dispatches|selectattr('status', 'ne', 'Received')|list|length }}</h4>
                  <p class="text-muted mb-0">Awaiting Action</p>
                </div>
              </div>
            </div>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="bi bi-inbox display-1 text-muted mb-3"></i>
            <h4 class="text-muted mb-2">No Dispatches to Receive</h4>
            <p class="text-muted mb-4">All incoming dispatches have been processed.</p>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">
              <i class="bi bi-house me-2"></i>Return to Dashboard
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.stat-card {
  transition: all 0.3s ease;
  border-left: 4px solid #2563eb !important;
}

.stat-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 8px 20px -3px rgba(0, 0, 0, 0.1);
}

.table tbody tr {
  transition: all 0.3s ease;
}

.table tbody tr:hover {
  background: rgba(37, 99, 235, 0.04) !important;
}

.badge {
  font-size: 0.75rem;
  padding: 0.5rem 0.75rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Initialize tooltips
  var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });

  // Add confirmation for receive actions
  const receiveForms = document.querySelectorAll('form[action="{{ url_for("dispatch_receive") }}"]');
  receiveForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      const dispatchId = this.querySelector('input[name="dispatch_id"]').value;
      if (!confirm(`Are you sure you want to mark Dispatch #${dispatchId} as received?`)) {
        e.preventDefault();
      }
    });
  });
});
</script>

{% endblock %}