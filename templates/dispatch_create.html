{% extends "base.html" %} {% block content %}
<div class="container mt-4">
  <h3>Create Dispatch</h3>
  <hr />

  <form method="POST">
    <!-- ✅ Supplier (A → B) -->
    {% if role == "Supplier" %}
    <div class="mb-3">
      <label class="form-label">Select Intermediate</label>
      <select name="to_user" class="form-select" required>
        <option value="">-- Select Intermediate --</option>
        {% for u in users %}
        <option value="{{ u.id }}">{{ u.username }}</option>
        {% endfor %}
      </select>
    </div>

    <!-- ✅ Supplier selects component -->
    <div class="mb-3">
      <label class="form-label">Select Component</label>
      <select name="component_id" class="form-select" required>
        {% for comp in components %}
        <option value="{{ comp.id }}">{{ comp.name }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <!-- ✅ Intermediate (B → C) -->
    {% if role == "Intermediate" %}
    <div class="mb-3">
      <label class="form-label">Select Parent Dispatch</label>
      <select
        name="parent_dispatch_id"
        class="form-select"
        required
        onchange="updateComponentName(this)"
      >
        <option value="">-- Select Dispatch --</option>
        {% for d, avail in parent_dispatches %}
        <option value="{{ d.id }}" data-component="{{ d.component }}">
          Dispatch #{{ d.id }} - {{ d.component }} | Available: {{ avail }}
        </option>
        {% endfor %}
      </select>
    </div>

    <!-- ✅ Component Name Auto-filled & Locked -->
    <div class="mb-3">
      <label class="form-label">Component</label>
      <input
        type="text"
        id="component_name"
        class="form-control"
        readonly
        required
      />
    </div>

    <!-- ✅ Intermediate selects ONLY End User -->
    <div class="mb-3">
      <label class="form-label">Send To End User (C)</label>
      <select name="to_user" class="form-select" required>
        <option value="">-- Select End User --</option>
        {% for u in users %}
        <option value="{{ u.id }}">{{ u.username }}</option>
        {% endfor %}
      </select>
    </div>
    {% endif %}

    <!-- ✅ Common Input Fields -->
    <div class="mb-3">
      <label class="form-label">FLC Quantity</label>
      <input
        type="number"
        name="flc_qty"
        class="form-control"
        required
        min="1"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">Component Quantity</label>
      <input
        type="number"
        name="component_qty"
        class="form-control"
        required
        min="1"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">Remarks</label>
      <textarea class="form-control" name="remarks"></textarea>
    </div>

    <button class="btn btn-primary" type="submit">Create Dispatch</button>
    <a class="btn btn-secondary" href="{{ url_for('dashboard') }}">Cancel</a>
  </form>
</div>

<script>
  function updateComponentName(select) {
    let compName =
      select.options[select.selectedIndex].getAttribute("data-component");
    document.getElementById("component_name").value = compName || "";
  }
</script>

{% endblock %}
