<!-- returns.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Return Entry - FLC Tracking</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body class="bg-light">
    {% include 'navbar.html' %}

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h3 class="text-primary mb-4">
                    <i class="bi bi-arrow-return-left me-2"></i>Return Entry
                </h3>

                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                {% endif %}
                {% endwith %}

                <!-- Return Form -->
                <div class="card shadow p-4 mb-4">
                    <form method="POST" action="{{ url_for('returns') }}">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Select Pending Dispatch</label>
                                <select name="dispatch_id" class="form-select" required id="dispatchSelect" onchange="updateEndUsers()">
                                    <option value="" disabled selected>-- Select a Pending Dispatch --</option>
                                    {% for d in dispatches %}
                                    <option value="{{ d.id }}" data-component="{{ d.component }}">
                                        ID {{ d.id }} â€” {{ d.component or 'N/A' }}
                                        | To: {{ d.receiver.username if d.receiver else d.to_role }}
                                        | Sent: {{ d.flc_qty }}
                                        | Returned: <span class="text-success fw-semibold">{{ d.total_returned }}</span>
                                        | Remaining: <span class="text-danger fw-semibold">{{ d.remaining }}</span>
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Returning From End User (Optional)</label>
                                <select name="from_end_user_id" class="form-select" id="endUserSelect">
                                    <option value="" selected>-- Select End User (Optional) --</option>
                                    {% for user in end_users %}
                                    <option value="{{ user.id }}">{{ user.name }}{% if user.location %} - {{ user.location }}{% endif %}</option>
                                    {% endfor %}
                                </select>
                                <small class="text-muted">Track which end user is returning the FLCs</small>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">FLC Quantity Returned</label>
                                <input type="number" name="flc_qty" class="form-control" min="1" required />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Remarks (Optional)</label>
                                <input type="text" name="remarks" class="form-control" placeholder="e.g., Damaged containers, routine return, etc." />
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 py-2">
                            <i class="bi bi-check-circle me-2"></i>Record Return
                        </button>
                    </form>
                </div>

                <!-- Recent Returns Table -->
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-clock-history me-2"></i>Recent Returns
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>ID</th>
                                        <th>Dispatch ID</th>
                                        <th>From End User</th>
                                        <th>FLC Qty</th>
                                        <th>Remarks</th>
                                        <th>Date/Time</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for r in returns %}
                                    <tr>
                                        <td>{{ r.id }}</td>
                                        <td>
                                            <span class="badge bg-secondary">#{{ r.dispatch_id }}</span>
                                        </td>
                                        <td>
                                            {% if r.from_end_user %}
                                                <span class="text-success">{{ r.from_end_user.name }}</span>
                                                {% if r.from_end_user.location %}
                                                    <br><small class="text-muted">{{ r.from_end_user.location }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">Not specified</span>
                                            {% endif %}
                                        </td>
                                        <td><strong class="text-primary">{{ r.flc_qty }}</strong></td>
                                        <td>{{ r.remarks or '-' }}</td>
                                        <td>{{ r.date_time.strftime('%Y-%m-%d %H:%M') if r.date_time else '' }}</td>
                                    </tr>
                                    {% else %}
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-4">
                                            <i class="bi bi-inbox me-2"></i>No returns recorded yet.
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateEndUsers() {
            // You can enhance this to filter end users based on the selected dispatch
            // For now, it just ensures the end user dropdown is available
            const dispatchSelect = document.getElementById('dispatchSelect');
            const endUserSelect = document.getElementById('endUserSelect');
            
            if (dispatchSelect.value) {
                endUserSelect.disabled = false;
            } else {
                endUserSelect.disabled = true;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateEndUsers();
        });
    </script>
</body>
</html>