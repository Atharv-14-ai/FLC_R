{% extends "base.html" %}
{% block content %}
<link href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css" rel="stylesheet">

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Analytics</h2>
  </div>

  <!-- KPI Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="d-flex justify-content-between">
          <form action="{{ url_for('update_inventory') }}" method="POST" class="mt-3">
    <div class="input-group" style="max-width: 250px;">
        <input type="number" name="add_qty" class="form-control" placeholder="Add FLC quantity" min="1" required>
        <button class="btn btn-primary" type="submit">Add</button>
    </div>
</form>

          <div>
            <small class="text-muted">Total Dispatches</small>
            <h3 id="k_total" class="mt-2">0</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-box-seam" style="font-size:28px;opacity:.7"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="d-flex justify-content-between">
          <div>
            <small class="text-muted">Pending</small>
            <h3 id="k_pending" class="mt-2 text-warning">0</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-hourglass-split" style="font-size:28px;opacity:.7"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="d-flex justify-content-between">
          <div>
            <small class="text-muted">Received</small>
            <h3 id="k_received" class="mt-2 text-success">0</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-check-circle" style="font-size:28px;opacity:.7"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card p-3 shadow-sm">
        <div class="d-flex justify-content-between">
          <div>
            <small class="text-muted">Total Returned</small>
            <h3 id="k_returned" class="mt-2 text-info">0</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-arrow-counterclockwise" style="font-size:28px;opacity:.7"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ✅ FLC Count Summary -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card p-3 shadow-sm border-primary">
        <div class="d-flex justify-content-between">
          <div>
            <small class="text-muted">FLCs at Supplier (A)</small>
            <h3 class="text-primary mt-2">{{ flc_summary.at_supplier }}</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-building" style="font-size:28px;opacity:.7"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3 shadow-sm border-warning">
        <div class="d-flex justify-content-between">
          <div>
            <small class="text-muted">FLCs at Intermediate (B)</small>
            <h3 class="text-warning mt-2">{{ flc_summary.at_intermediate }}</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-truck" style="font-size:28px;opacity:.7"></i>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card p-3 shadow-sm border-success">
        <div class="d-flex justify-content-between">
          <div>
            <small class="text-muted">FLCs at End User (C)</small>
            <h3 class="text-success mt-2">{{ flc_summary.at_enduser }}</h3>
          </div>
          <div class="align-self-center">
            <i class="bi bi-person-circle" style="font-size:28px;opacity:.7"></i>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Charts row -->
  <div class="row mb-4">
    <div class="col-lg-7">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Dispatch & Returns (last 7 days)</h5>
        <canvas id="trendChart" height="140"></canvas>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card p-3 shadow-sm">
        <h5 class="mb-3">Status Distribution</h5>
        <canvas id="statusDonut" height="200"></canvas>
      </div>
    </div>
  </div>

  <!-- FLC cycle animation & activity -->
  <div class="row justify-content-center mb-4">
    <div class="col-lg-8">
      <div class="card p-3 shadow-sm">
        <h5>FLC Movement — Cycle View</h5>
        <div class="d-flex justify-content-around align-items-center py-3">
          <div class="text-center">
            <div class="p-3 rounded-circle bg-primary text-white animate__animated animate__pulse animate__infinite">A<br><small>Supplier</small></div>
          </div>
          <div class="text-center">
            <div class="p-3 rounded-circle bg-warning text-dark animate__animated animate__pulse animate__infinite">B<br><small>Intermediate</small></div>
          </div>
          <div class="text-center">
            <div class="p-3 rounded-circle bg-success text-white animate__animated animate__pulse animate__infinite">C<br><small>End User</small></div>
          </div>
        </div>
        <small class="text-muted">Animated dots show direction of the typical flow: A → B → C → A</small>
      </div>
    </div>
  </div>
</div>

    
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  let chart_data = {{ chart_data|safe }};
  const stats = {
    total: {{ stats.total_dispatches }},
    pending: {{ stats.pending }},
    received: {{ stats.received }},
    returned: {{ stats.returned }}
  };

  function animateCount(id, target, duration=900) {
    const el = document.getElementById(id);
    if (!el) return;
    const start = 0;
    const range = target - start;
    const stepTime = Math.max(Math.floor(duration / (range || 1)), 12);
    let current = start;
    const timer = setInterval(() => {
      current += Math.ceil(range / (duration/stepTime));
      if (current >= target) {
        el.textContent = target;
        clearInterval(timer);
      } else {
        el.textContent = current;
      }
    }, stepTime);
  }

  animateCount('k_total', stats.total);
  animateCount('k_pending', stats.pending);
  animateCount('k_received', stats.received);
  animateCount('k_returned', stats.returned);

  const ctx = document.getElementById('trendChart').getContext('2d');
  const trendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: chart_data.labels,
      datasets: [
        { label: 'Dispatches', data: chart_data.dispatch_series, borderWidth: 2, tension: 0.3 },
        { label: 'Returns', data: chart_data.returns_series, borderWidth: 2, tension: 0.3 }
      ]
    },
    options: { responsive: true, interaction:{mode:'index',intersect:false}, plugins:{legend:{position:'top'}}, scales:{y:{beginAtZero:true}} }
  });

  const donutCtx = document.getElementById('statusDonut').getContext('2d');
  const statusLabels = Object.keys(chart_data.status_map);
  const statusVals = Object.values(chart_data.status_map);
  const colors = ['#ffc107','#0d6efd','#198754','#6c757d','#dc3545'];

  const donutChart = new Chart(donutCtx, {
    type: 'doughnut',
    data: { labels: statusLabels, datasets:[{ data: statusVals, backgroundColor: colors.slice(0, statusLabels.length) }] },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });
</script>
{% endblock %}
